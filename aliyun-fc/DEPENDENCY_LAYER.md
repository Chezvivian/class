# 阿里云函数计算依赖层配置

## 问题

阿里云函数计算提示：
> "您仅需要提供 Python 的 requirements.txt 或者 Node.JS 的 package.json 即可在云上安装依赖。点击这里立即在云上构建依赖层！"

这说明阿里云函数计算需要**单独的依赖层**来安装依赖。

## 解决方案

### 方案1：在云上构建依赖层（推荐）

#### 步骤1：准备 package.json

确保你有正确的 `package.json` 文件：

```json
{
  "name": "azure-tts-aliyun-fc-proxy",
  "version": "1.0.0",
  "dependencies": {
    "axios": "^1.6.0"
  }
}
```

#### 步骤2：在阿里云控制台创建依赖层

1. **进入函数详情页**
   - 进入 `voices-proxy` 函数
   - 点击"函数代码"标签

2. **查找"依赖层"或"层"选项**
   - 可能在"函数配置"中
   - 或者在"编辑层"选项中（用户提到的）
   - 或者在代码页面的某个按钮

3. **点击"立即在云上构建依赖层"**
   - 按照提示操作
   - 上传或指定 `package.json` 文件位置
   - 系统会自动构建依赖层

4. **等待构建完成**
   - 依赖层构建可能需要几分钟
   - 等待构建完成后再测试

#### 步骤3：将依赖层绑定到函数

1. **进入函数配置**
   - 进入函数详情页
   - 点击"函数配置"或"层"标签

2. **添加依赖层**
   - 找到"层"或"依赖层"配置
   - 选择刚才创建的依赖层
   - 保存配置

3. **重新部署函数**
   - 部署后，依赖层会自动应用到函数

### 方案2：直接上传 package.json 并触发构建

1. **进入函数代码页面**

2. **确保 package.json 存在**
   - 如果没有，创建文件：`package.json`
   - 内容：
   ```json
   {
     "dependencies": {
       "axios": "^1.6.0"
     }
   }
   ```

3. **点击"在云上构建依赖层"按钮**
   - 按照提示操作
   - 系统会自动识别 `package.json` 并构建依赖层

4. **等待构建完成并部署**

### 方案3：手动创建依赖层（如果界面支持）

某些阿里云函数计算版本可能支持手动创建：

1. **进入依赖层管理**
   - 在阿里云函数计算控制台
   - 查找"层"或"依赖层"菜单

2. **创建新层**
   - 名称：如 `tts-dependencies`
   - 运行时：Node.js 18
   - 上传方式：上传 `package.json`

3. **构建层**
   - 系统会自动构建包含依赖的层

4. **绑定到函数**
   - 进入函数配置
   - 添加刚创建的依赖层
   - 保存并部署

## 验证方法

依赖层构建成功后：

1. **查看函数配置**
   - 进入函数配置页面
   - 查看"层"配置，应该能看到依赖层

2. **测试调用**
   ```bash
   curl -v https://your-voices-trigger-url
   ```
   - 如果不再报 "Cannot find module 'axios'"，说明成功

3. **查看函数代码**
   - 进入函数代码页面
   - 可能能看到依赖层的引用
   - 或者能看到依赖已加载的信息

## 注意事项

1. **依赖层构建时间**
   - 首次构建可能需要几分钟
   - 请耐心等待

2. **依赖层大小限制**
   - 阿里云可能有依赖层大小限制
   - axios 很小，应该没问题

3. **多个函数共享依赖层**
   - 如果创建了依赖层，可以在多个函数中共享
   - `tts-proxy` 和 `voices-proxy` 都可以使用同一个依赖层

## 推荐操作流程

### 对于 voices-proxy 函数：

1. **确保 package.json 存在**
   - 在函数代码页面
   - 如果没有，创建 `package.json`

2. **点击"在云上构建依赖层"**
   - 按照提示操作
   - 等待构建完成

3. **将依赖层绑定到函数**
   - 进入函数配置
   - 添加依赖层
   - 保存并部署

4. **测试**
   ```bash
   curl -v https://your-voices-trigger-url
   ```

### 对于 tts-proxy 函数：

- 可以使用同一个依赖层
- 或者重复上述步骤创建新的依赖层

## 如果找不到"构建依赖层"选项

可能的位置：
1. 函数代码页面 → 某个按钮或链接
2. 函数配置页面 → "层"或"依赖层"选项
3. 左侧菜单 → "层"或"依赖层"管理
4. 代码编辑器上方 → "安装依赖"或"构建依赖"按钮

如果实在找不到，可以：
1. 联系阿里云技术支持
2. 或者使用之前的方案：本地安装依赖并打包 node_modules

