# 依赖层问题排查指南

## 问题

即使购买了WebIDE服务并创建了自定义层，仍然报错：
```
Error: Cannot find module 'axios'
```

## 可能的原因

1. **依赖层没有绑定到函数**
2. **依赖层构建失败或没有包含axios**
3. **依赖层路径配置错误**
4. **函数配置中层的顺序或路径不对**

## 排查步骤

### 步骤1：检查依赖层是否已绑定到函数

1. **进入函数配置页面**
   - 进入 `voices-proxy` 函数详情页
   - 点击"函数配置"标签

2. **查找"层"或"依赖层"配置**
   - 应该能看到依赖层的列表
   - 确认依赖层已添加并启用

3. **如果没有绑定，添加依赖层**
   - 点击"添加层"或"编辑层"
   - 选择你创建的自定义依赖层
   - 保存配置

### 步骤2：检查依赖层的构建状态

1. **进入依赖层管理页面**
   - 在阿里云函数计算控制台
   - 找到"层"或"依赖层"管理

2. **检查层的构建状态**
   - 确认层的状态是"已构建"或"正常"
   - 如果状态是"构建中"或"失败"，需要等待或重新构建

3. **检查层的运行环境**
   - 确认运行环境是 Node.js 18
   - 确认与函数的运行环境匹配

### 步骤3：检查依赖层的内容

1. **查看依赖层的详情**
   - 进入依赖层详情页
   - 确认 package.json 是否正确上传
   - 确认依赖是否已正确安装

2. **检查 layer 路径**
   - 确认依赖安装路径是否正确
   - Node.js 层的依赖通常应该在 `/opt/nodejs/node_modules/`

### 步骤4：验证依赖层配置

在函数配置中，依赖层应该：

1. **已添加**：在函数配置的"层"列表中能看到
2. **顺序正确**：如果有多个层，自定义依赖层应该在合适的位置
3. **路径正确**：系统会自动处理路径，但需要确认

### 步骤5：重新部署函数

即使依赖层配置正确，也需要：

1. **保存函数配置**
2. **重新部署函数**
3. **等待部署完成**

## 解决方案

### 方案A：重新构建依赖层

1. **进入依赖层管理**
   - 找到你创建的自定义依赖层

2. **删除旧的依赖层**
   - 如果构建失败或内容不对，删除重建

3. **重新创建依赖层**
   - 确保 package.json 内容正确：
   ```json
   {
     "dependencies": {
       "axios": "^1.6.0"
     }
   }
   ```
   - 重新构建依赖层
   - 等待构建完成

4. **绑定到函数**
   - 进入函数配置
   - 添加重新构建的依赖层
   - 保存并重新部署函数

### 方案B：检查依赖层的安装路径

Node.js 依赖层的依赖通常安装在：
- `/opt/nodejs/node_modules/`

但函数代码中的 `require('axios')` 会从：
- `/code/node_modules/`（函数代码目录）
- 然后是 `/opt/nodejs/node_modules/`（依赖层）

确保依赖层构建时，依赖安装在了正确的位置。

### 方案C：在函数代码中也包含 package.json（双重保险）

即使有依赖层，也可以在函数代码中保留 `package.json`：

1. **在函数代码页面**
   - 确保有 `package.json` 文件
   - 内容：
   ```json
   {
     "dependencies": {
       "axios": "^1.6.0"
     }
   }
   ```

2. **同时配置依赖层**
   - 在函数配置中添加依赖层
   - 这样双重保险

3. **重新部署**

### 方案D：本地打包 node_modules（最可靠）

如果依赖层始终不工作，可以回到本地打包方案：

1. **在本地安装依赖**
   ```bash
   npm install
   ```

2. **打包包含 node_modules**
   ```bash
   zip -r voices-proxy.zip . -x "*.git*"
   ```

3. **上传到阿里云**
   - 这样不依赖依赖层，100%可靠

## 快速诊断

### 检查清单

- [ ] 依赖层已创建并构建成功
- [ ] 依赖层已绑定到函数（在函数配置中能看到）
- [ ] 依赖层的运行环境是 Node.js 18（与函数匹配）
- [ ] 函数代码中有 `package.json`（至少包含 axios 依赖）
- [ ] 函数已重新部署（绑定层后）
- [ ] 等待了足够的部署时间

### 如果以上都正确但仍有问题

可能的原因：
1. **依赖层路径不对**：系统可能没有正确挂载依赖层
2. **层的版本问题**：可能需要重新构建
3. **缓存问题**：尝试删除并重新创建函数

## 推荐操作流程

### 步骤1：验证依赖层配置

1. 进入函数配置页面
2. 查看"层"配置
3. 确认依赖层已添加

### 步骤2：检查层的构建状态

1. 进入依赖层管理
2. 查看层的状态和详情
3. 确认构建成功

### 步骤3：重新部署函数

1. 保存配置
2. 重新部署函数
3. 等待部署完成

### 步骤4：如果还是不行

使用本地打包方案（方案D），这是最可靠的方法，不依赖依赖层机制。

## 验证方法

部署后测试：

```bash
curl -v https://your-voices-trigger-url
```

如果不再报 "Cannot find module 'axios'"，说明成功。

如果仍然报错，请告诉我：
1. 函数配置中"层"的列表（有哪些层）
2. 依赖层的状态（已构建/构建中/失败）
3. 函数代码中是否有 `package.json`

这样我可以进一步诊断。

